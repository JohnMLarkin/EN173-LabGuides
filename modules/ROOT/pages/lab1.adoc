:lab: 1
:sectnums:
:source-language: c
:listing-caption: Program
:example-caption: Exercise
:icons: font
:experimental:
= Lab 1

== Installing the tools

== An embedded "`Hello, world`"

On a general purpose computer the stereotypical first program in a language displays `Hello, world!` on the screen. In the world of microcontrollers the equivalent is to flash an LED. This is also called a heartbeat program. It is a simple way to indicate that your microcontroller is alive and you are able to transfer a simple program to it. Most development boards will have one or more integrated LEDs, so no external connections are necessary. The https://www.nordicsemi.com/Products/Development-hardware/nRF52840-DK[Nordic Semiconductor nRF52840 DK] that will be our example development board has four integrated LEDs. The first program will flash one of these, labeled LED1, off and on forever (or as long as the microcontroller is powered). Flow charts are a useful tool for planning and documenting code, so before we jump into the code itself we start with a flow chart for this first program.

```mermaid
graph TD
  A("main()") --> B[Initialize LED1]
  B --> C{Is it true?}
  C --> |yes| D[Turn on LED1]
  D --> E([Sleep 250 ms])
  E --> F[Turn off LED1]
  F --> G([Sleep 250 ms])
  G --> C
```

=== Creating a new application

=== Entering the code

Replace the contents of `main.c` (in the `src` folder) with the following code. **Always** type the code from these lab guides into the editor yourself; don't copy and paste it. You will pay more attention to the details of the code and learn it better if you type it.

[source]
[[program-blink-internal-LED]]
.A program to blink an internal LED.
----
/********************************
 * Heartbeat program
 * 
 * Flashes an internal LED
 *******************************/
#include <zephyr/kernel.h>        // <1>
#include <zephyr/drivers/gpio.h>

#define LED0_NODE DT_ALIAS(led0)  // <2>
static const struct gpio_dt_spec led = GPIO_DT_SPEC_GET(LED0_NODE, gpios);  // <3>

int main() {  // <4>
	gpio_pin_configure_dt(&led, GPIO_OUTPUT_ACTIVE);  // <5>
	while (true) {
		gpio_pin_set_dt(&led,1); // 1 = ACTIVE = ON
		k_msleep(250);
		gpio_pin_set_dt(&led,0); // 0 = INACTIVE = OFF
		k_msleep(250);
	}
}
----
<1> Zephyr is designed to be lightweight so only the components you need are included. These import Zephyr's Kernel and GPIO APIs.
<2> Information about the hardware is stored in something called the devicetree. This looks up the identifier for the LED associated with the alias `led0`.
<3> This creates a container called `led` that holds information about a GPIO pin.
<4> The Zephyr RTOS looks for a user-defined function called `main` to run after it completes its start-up. This is often the heart of your application.
<5> The GPIO pin linked to LED1 is configured as an output and set to be in the active (on) state.



=== Documenting the first program
Create a new file called `README.md` in the `src` folder. This is where you will put some human-friendly documentation using a simple and widely used markup language called https://guides.github.com/features/mastering-markdown/[Markdown]. We will also supplement Markdown with  https://mermaid-js.github.io/[mermaid], a diagram-drawing language that will let us include graphics like flowcharts in our documentation.

Before you start adding contents to this file, turn on VS Code's Markdown previewer by clicking on the "`Open Preview to the Side`" button (or type kbd:[Ctrl+k] and then kbd:[v]).

// [#img-vscode-markdown-preview]
// .VS Code button for Markdown preview.
// image::vscode-markdown-preview.png[Button that opens a Markdown preview in side pane, 655, 31]

Entering the following code into the `README.md` file.
[source,markdown]
[[readme-blink-internal-LED]]
.Documentation for the heart beat program.
----
# Program 1: Heartbeat                              // <1>
**Author:** John M. Larkin <jlarkin@whitworth.edu>  // <2>
**Date:** December 31, 2024

**Modified by:** 
**Date:**

**Purpose:** This program flashes an internal LED on the nRF52840 DK

## Configuration
Uses default devicetree configuration.

## Hardware                                     // <3>
### Internal
* LED1 (digital output)                         // <4>

## Flow
```mermaid                                      // <5>
graph LR                                        // <6>
  A("main()") --> B[Initialize LED1]
  B --> C{Is it true?}                          // <7>
  C --> |yes| D[Turn on LED1]                   // <8>
  D --> E([Sleep 250 ms])
  E --> F[Turn off LED1]
  F --> G([Sleep 250 ms])
  G --> C
```
----
<1> Section headings are created in Markdown by starting a line with one or more `\#` followed by a space and then the name of the section. A top-level section is one `#`, a second-level section starts with `##`, and so forth.
<2> Markdown puts text in bold if it is surrounded by `**`. It formats something as a click-able email link or URL if it is inside of `<` and `>`. Also, this line ends with two space characters. This creates a line break. Otherwise, the next line would be wrapped as a continuation of this line.
<3> Our microcontroller will nearly always be connected to additional components. Part of good documentation will be describe those in the README file.
<4> An itemized list has items that start with `\*`, then a space, and that is followed by the description of the item. The space between `*` and the description is required.
<5> The start of a mermaid code block begins with ````mermaid`.
<6> This flowchart is arranged from left to right. Another common arrangement is top to bottom (`TB`).
<7> Nodes are named (the letters) and labeled (the text inside the various delimiters). Connections between nodes are given by `-\->`. Different delimiters create different shapes of nodes. Conditional branching is traditionally inside of a diamond, created in mermaid with `{` and `}` delimiters.
<8> Text can be place along a connecting line by placing it inside of a pair of `|` after the connector code (`-\->`).

=== Modifying the first program

====
[[exercise-sweep-internal-led-flow]]
.Exercise {lab}.{counter:exercise}
Create a new application called `cycle-blinky`. In this project, create a `README.md` file. Use the README file for <<program-blink-internal-LED>> as template and modify as appropriate.

Create a flow chart for a program that would light the four integrated LEDs in the sequence LED1 -> LED2 -> LED3 -> LED4 (and then repeat forever).  Each LED should be lit for 0.25 s and it should appear that only one is on at a time (though there might actually be some very small overlap).
====

====
[[exercise-sweep-internal-led-program]]
.Exercise {lab}.{counter:exercise}
Starting with <<program-blink-internal-LED>>, change the code so that it implements the logic shown in the flow chart created for <<exercise-sweep-internal-led-flow>>.
====

IMPORTANT: Show your flow chart and working program when you are done.